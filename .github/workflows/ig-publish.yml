name: ImplementationGuide Publisher (CI Build)

on:
  # Triggers the workflow on push or pull request events but only for the main or master branch
  push:
    branches:
      - main
      - master
      - staging
  pull_request:
    branches:
      - main
      - master
      - staging

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
  contents: write
    
jobs:
  run-publisher:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    env:
      JAVA_TOOL_OPTIONS: "-Xmx6g"

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo snap install yq

      # read id, version and canonical from sushi-config.yaml
      - name: Read YAML file
        id: yaml-data
        run: |
          VERSION=$(yq eval '.version' sushi-config.yaml)
          ID=$(yq eval '.id' sushi-config.yaml)
          CANONICAL=$(yq eval '.canonical' sushi-config.yaml)
          FHIRVERSION=$(yq eval '.fhirVersion' sushi-config.yaml)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "id=$ID" >> $GITHUB_OUTPUT
          echo "canonical=$CANONICAL" >> $GITHUB_OUTPUT
          echo "fhir_version=$FHIRVERSION" >> $GITHUB_OUTPUT

      # display outputs from read-yaml action
      - name: Display read-yaml output
        run: |
          echo "id: ${{ steps.yaml-data.outputs.id }}"
          echo "target url: ${{ steps.yaml-data.outputs.canonical }}"
          echo "version: ${{ steps.yaml-data.outputs.version }}"
          echo "fhir_version: ${{ steps.yaml-data.outputs.fhir_version }}"

      - name: Install EBM IG continuous build
        run: ./download-ebm-ig.sh

      - name: Run the IG publisher
        uses: docker://hl7fhir/ig-publisher-base:latest
        with:
          # Append -snapshot to version to trigger CI build mode in run-ig-publisher.sh
          args: ./run-ig-publisher.sh ${{ steps.yaml-data.outputs.canonical }} ${{ steps.yaml-data.outputs.version }}-snapshot

      # deploy implementation guide to github pages
      - name: Deploy
        if: (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output
          force_orphan: true


      # ───────────  Upload CI build to AWMF host  ───────────
      # NOTE: CI builds go to /ci-build/ subdirectory to preserve published versions
      # Published versions are managed by ig-publish-version.yml workflow
      - name: Prepare SSH key
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWMF_IG_SSH_KEY }}" > /tmp/awmf_ig_publisher.id_ed25519
          chmod 600 /tmp/awmf_ig_publisher.id_ed25519
          # (safer than StrictHostKeyChecking=no)
          ssh-keyscan -p 221 register.awmf.org >> ~/.ssh/known_hosts

      - name: Check for existing published version
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        id: check-published
        run: |
          # Check if package-list.json exists on server (indicates published versions exist)
          if ssh -p 221 -i /tmp/awmf_ig_publisher.id_ed25519 \
              awmf_ig_publisher@register.awmf.org \
              "test -f ./${{ steps.yaml-data.outputs.id }}/package-list.json" 2>/dev/null; then
            echo "has_published_version=true" >> $GITHUB_OUTPUT
            echo "Found existing published versions"
          else
            echo "has_published_version=false" >> $GITHUB_OUTPUT
            echo "No published versions found - CI build will also serve as root"
          fi

      - name: Rsync CI build to register.awmf.org
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          PACKAGE_ID="${{ steps.yaml-data.outputs.id }}"
          
          # Always deploy CI build to /ci-build/ subdirectory
          rsync -av --delete \
                -e "ssh -p 221 -i /tmp/awmf_ig_publisher.id_ed25519" \
                ./output/ awmf_ig_publisher@register.awmf.org:./${PACKAGE_ID}/ci-build/
          
          echo "CI Build deployed to: ${{ steps.yaml-data.outputs.canonical }}/ci-build/"
          
          # If no published version exists yet, also deploy to root (excluding ci-build/)
          if [ "${{ steps.check-published.outputs.has_published_version }}" = "false" ]; then
            echo "No published version yet - also deploying to root..."
            rsync -av --delete --exclude 'ci-build/' \
                  -e "ssh -p 221 -i /tmp/awmf_ig_publisher.id_ed25519" \
                  ./output/ awmf_ig_publisher@register.awmf.org:./${PACKAGE_ID}/
            echo "Also deployed to root: ${{ steps.yaml-data.outputs.canonical }}/"
          fi
          
          echo "========================================="
          echo "CI Build deployed to:"
          echo "  ${{ steps.yaml-data.outputs.canonical }}/ci-build/"
          if [ "${{ steps.check-published.outputs.has_published_version }}" = "false" ]; then
            echo "  ${{ steps.yaml-data.outputs.canonical }}/ (no release yet)"
          fi
          echo "========================================="
